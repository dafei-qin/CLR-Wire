# Test Dataset Latent - Visualization Tool

## Overview

`test_dataset_latent.py` is an interactive visualization tool that:

1. **Loads** latent representations from NPZ files generated by `surface_to_latent.py`
2. **Decodes** latent vectors using VAE to get canonical space parameters
3. **Transforms** back to original space using `from_canonical`
4. **Visualizes** surfaces with gradient colors based on bbox sorting order

## Usage

```bash
python src/tests/test_dataset_latent.py \
    <npz_dir> \
    <checkpoint_path> \
    [--device cuda] \
    [--index 0] \
    [--latent_dim 128]
```

### Arguments

- `npz_dir`: Directory containing NPZ files (output from `surface_to_latent.py`)
- `checkpoint_path`: Path to VAE model checkpoint
- `--device`: Device to use (cpu or cuda), default: cpu
- `--index`: Initial sample index to display, default: 0
- `--latent_dim`: Latent space dimension, default: 128

### Example

```bash
python src/tests/test_dataset_latent.py \
    ../data/latent_abc \
    checkpoints/vae_v1_best.pth \
    --device cuda \
    --index 21
```

## Interactive Controls

### UI Controls

- **Sample Index Slider**: Scroll through different samples
- **Go To Index Input**: Jump to a specific sample
- **Colormap Radio Buttons**: Switch between color gradients
  - Rainbow (default)
  - Viridis
  - Cool to Warm
  - Red to Blue
- **Show Surfaces Checkbox**: Toggle surface visibility
- **Previous/Next Buttons**: Navigate between samples

### Keyboard Shortcuts

- **← (Left Arrow)**: Previous sample
- **→ (Right Arrow)**: Next sample

## Gradient Color Interpretation

Surfaces are colored with a gradient based on their sorting order (by bounding box):

- **Red/Start of gradient**: Surfaces with smaller X coordinates (left)
- **Blue/End of gradient**: Surfaces with larger X coordinates (right)

The sorting follows the priority: **X > Y > Z**
- Primarily sorted by X (left to right)
- Secondarily by Y when X is equal (front to back)
- Tertiary by Z when X and Y are equal (bottom to top)

## Workflow

```
NPZ File
   ↓
Load: latent_params, rotations, scales, shifts, classes, bbox_mins, bbox_maxs
   ↓
VAE Decode: latent_params + classes → canonical params
   ↓
from_canonical: canonical params + (shift, rotation, scale) → original params
   ↓
visualize_json_interset: original params → 3D meshes
   ↓
Apply gradient colors based on sorting order
   ↓
Display in Polyscope
```

## Technical Details

### Rotation Matrix Reconstruction

The NPZ files store only the first 6 elements of the 3×3 rotation matrix (first two rows).
The third row is reconstructed using cross product:

```python
row1 = rotation_6d[:3]
row2 = rotation_6d[3:6]
row3 = np.cross(row1, row2)
rotation_matrix = np.array([row1, row2, row3])
```

### Color Gradients

Available colormaps:
1. **Rainbow**: Full HSV spectrum (red → yellow → green → cyan → blue → magenta)
2. **Viridis**: Perceptually uniform colormap (purple → blue → green → yellow)
3. **Cool to Warm**: Blue → purple → red gradient
4. **Red to Blue**: Simple red to blue gradient

### Validation

This tool is useful for:
- Verifying VAE reconstruction quality
- Checking if `from_canonical` correctly recovers original space
- Visualizing bbox-based sorting order
- Debugging surface transformations
- Quality control of the latent encoding pipeline

## Output Information

The console displays:
```
Processing sample 21 with 15 surfaces
Visualized 15 surfaces with rainbow colormap
First surface bbox: [-1.234  0.567 -0.890]
Last surface bbox: [ 2.345  1.678  0.123]
Surface types: [0 1 2 3 0 1 2 3 0 1 2 3 0 1 2]
```

- Number of valid surfaces in the sample
- Colormap being used
- Bounding box of first and last surfaces (showing sorting range)
- Surface type distribution

## Troubleshooting

### Issue: "CUDA not available"
- The script will automatically fall back to CPU
- For faster processing, ensure PyTorch with CUDA is installed

### Issue: "No valid surfaces"
- The sample may have no valid surfaces due to parsing errors
- Try a different sample index

### Issue: Surfaces look wrong
- Check that the VAE checkpoint matches the model architecture
- Verify that canonical transformation was used correctly when generating NPZ files
- Ensure NPZ files were generated with the same dataset settings

### Issue: Colors not showing gradient
- Some surface types may not support vertex colors
- The gradient is applied to mesh vertices; check if meshes are being generated

## Related Files

- **Input**: NPZ files from `src/process_data/surface_to_latent.py`
- **VAE Model**: `src/vae/vae_v1.py`
- **Transformation**: `src/tools/surface_to_canonical_space.py`
- **Visualization**: `utils/surface.py`
- **Dataset**: `src/dataset/dataset_latent.py`


